[toc]

# 一、设计文档

## 1 项目概述

本报告为2021年《B/S体系软件设计》课程项目报告的第一部分——设计文档。

该文档写于项目开始前，并在开发过程中进行修改和完善。

设计文档的目的是分析确定项目的功能需求，初步确定项目所需要的技术框架，设计项目整体的体系结构、各模块的功能，并初步确定数据库结构、UI界面原型等要素，为接下来课程项目的进一步开发打下基础。

课程项目的主题是“物联网应用网站”。该项目选取的方向是“**智慧病房——医疗物联网系统**”，意在构建一个医疗场景下的物联网应用管理平台。该项目的适用范围是接入了只能物联网设备的医院、病房，适用用户是医院管理员、医生和病患，项目将针对智慧病房内的物联网设备构建一个交互体验良好、功能完善的管理平台，让使用者能够轻松接入和管理物联网设备、收集设备在不同时间和位置发来的数据、并进行丰富全面的可视化数据分析。

**相较于初版设计文档，该版本增加了：**

 - **新的扩展功能**
 - 各功能具体实现方法的细节说明
 - 使用**技术栈的更新**
 - 技术栈的细节说明
 - 数据库表头的微小更新
 - API更新



## 2 需求分析

### 2.1 基础功能

本项目设定的应用场景是医院物联网系统管理。我们假定目标医院下有设多个病房，每个病房内设有多张病床。每个物联网设备可以部署到一个病房（如室内温度、湿度监控设备），也可以部署到一张病床（如病人生命体征心率、体温监控设备）。系统的使用者包括该系统的管理人员、医生、病患三种类型。

根据课程实验的相关要求和具体应用场景，本项目实现了以下的基础功能：

1. **搭建一个MQTT服务器，能够接受来自指定物联网终端模拟器的数据**（已实现）

   项目将搭建一个简单的MQTT服务器，该服务器可以实现

   - 与MQTT主服务器的连接
   - 订阅和取消订阅指定Topic
   - 接收该Topic上的消息
   - 向该Topic上发送消息

   **实现方法：**

   该功能使用Python语言，基于`paho-mqtt`库、EMQ X CLOUD免费公用服务器实现。

   `paho-mqtt`是目前Python中使用较多的MQTT客户端库，它提供了一些基础MQTT辅助函数，使得和MQTT服务器的连接变得简单。

   [EMQ X CLOUD](https://www.emqx.cn/mqtt/public-mqtt5-broker)是一款开源的物联网MQTT免费公用服务器。

   本项目分别实现了向服务器发送（publish）、订阅并接受（subscribe）的两个Python程序。通过调用`paho-mqtt`提供的函数，设定好连接参数，程序就可以接入EMQ X CLOUD服务器，并在名为`python-mqtt/tcp`的Topic下进行不停发送和接收数据。

   

2. **实现用户注册、登录功能。用户注册时需要填写必要的信息并验证，如用户名、密码要求在6字节以上，email的格式验证，并保证用户名和email在系统中唯一**（已实现）

   项目中对用户信息的约束如下：

   - 用户名非空，可重复
   - 账号非空（满足浙江大学学号格式），不可重复
   - 邮箱非空，不可重复
   - 密码长度至少为6

   **实现方法：**

   首先，在用户注册的前端界面中，对表单的输入进行约束，此时可以保证必要信息非空、邮箱满足邮箱格式、账号满足浙江大学学号格式、密码长度至少为6。若不满足这些要求，前端界面会给出提示，并且禁止提交表单。

   其次，在后端实现中，后端会对前端发来的注册信息进行查重，如果发现账号和邮箱号在数据库中已存在，则会返回错误信息。

   最后，在数据库层面，我们在创建用户信息表的时候就对表内各字段进行primary key、unique的约束，保证不合规范的信息无法插入表。

   对于登录状态的保持，使用HTML5新支持的特性——localStorage实现。该方法类似于sessionStorage，但其生命周期是永久的，且可以在不同标签页间共享，免去了反复登录的繁琐。

   

3. **提供设备配置界面，可以创建或修改设备信息；包含必要信息，如设备ID、设备名称等**（已实现）

   提供”设备管理“界面，在该界面用户可以：

   - 查看所有现有设备的信息，包括

     - 设备ID：设备的唯一标识符
     - 设备名
     - 设备状态：在线、离线、故障
     - 数据类型：室温、室内湿度、患者体温、患者心率
     - 数据单位
     - 时间步长：设备两次发送数据的实际间隔
     - 病房ID：设备所部署的病房ID 
     - 病床ID：设备所部署的病床ID（若未部署到具体病床，则该项设为某特殊值）

   - 修改现有设备的信息

     用户只能修改除设备ID外的其他信息

   - 创建新的设备

     用户输入除设备ID外的其他信息，提交后由后端分配一个ID

   - 删除现有设备

   - 通过关键字对设备进行筛选（新增）

     可供筛选的字段有：

     - 设备ID
     - 设备名
     - 数据类型
     - 设备状态

   - 将勾选的设备信息导出为excel表格（新增）

     可通过勾选框勾选设备行，通过按钮导出已选设备到excel表格，下载保存到本地。

   **实现方法：**

   在数据库中，我们使用单独的一张表格tb_facility保存所有设备的所有信息。后端将会向前端提供该表的增、删、改、查接口。在前端界面中，使用一个单独的界面作为”设备管理“界面。

   - 前端通过后端的”查“接口获取所有设备的信息并以表格的形式显示在网页中。对表格的每一列提供”编辑“和”删除“的按钮，并在表格前单独显示”新增设备“按钮。用户触发相应按钮、填写必要信息并提交后，前端将会调用后端提供的”增“、”改“、”删“接口对数据库内的设备信息进行修改。同时重新获取所有设备信息，刷新页面。
   - 对于信息的筛选，则完全交由前端实现。用户输入筛选关键词后，前端从原始数据中筛选出包含关键词的数据行并显示，不包含关键词的则不作显示。
   - 对于导出excel这一功能，同样由前端完成。首先通过JavaScript实现一个小组件，完成对JSON数据进行分析并导出为excel的功能；具体在”设备管理“界面中，点击”导出excel“按钮后，将会把勾选的数据交由这一组件进行处理、导出。

   

4. **提供设备上报数据的查询统计界面**（已实现）

   提供”数据总览“界面，在该界面用户可以：

   - 查看系统所有数据的信息，包括：
     - 该条数据的ID：一条数据的唯一标识符
     - 发送该条数据的设备ID
     - 数据的发送时间
     - 数据的发送位置
       - 经度
       - 纬度
     - 数据的具体数值
     - 数据的单位：由设备确定
     - 数据的类型：室温、室内湿度、患者体温、患者心率，同样由设备确定
     - 设备是否正常：正常、警告
   - 删除一条数据
   - 通过关键字对数据进行筛选（新增）
   - 将勾选的数据导出为excel表格（新增）

   **实现方法：**

   我们单独使用一张表格tb_data保存接收到的所有数据信息。

   需要注意的时，显示数据信息时，后端返回所有数据信息时，还要通过查询tb_facility设备返回该条数据对应设备的信息：如数据单位和数据类型。

   该界面其他功能（数据筛选、导出Excel）和上一部分”设备管理“界面实现方法类似。

   

5. **提供地图界面展示设备信息，区分正常和告警信息，并可以展示历史轨迹**（已实现）

   提供”地图视图“界面，在该界面：

   - 显示一张地图，地图上每条数据信息都对应了一个标记点。
     - 标记点的位置反映该条数据的发送位置
     - 标记点的图表（正常、警告）反映了该条数据是否正常
   - 用户可以通过”显示轨迹线“开关，控制地图是否显示轨迹线。
     - 每条轨迹线都按照时间顺序连接了同一个设备发送的所有数据
     - 轨迹线反映了设备的移动轨迹
   - 用户可以通过筛选框，选择只看某个设备的数据标记点和轨迹线
   - 用户可以点击地图中的数据标记点，通过信息窗口查看该条数据的详细信息
   - 地图下方将会显示一张数据表格，具体展示当前地图中所有数据标记点的详细信息

   **实现方法：**

   - 前端通过[Google Map](https://developers.google.com/maps/documentation/javascript/overview)调用地图显示API，显示地图。
   - 后端提供接口：
     - 标记点：遍历数据，每条数据形成一个地图Marker，返回所有Marker配置信息，传给前端在地图上渲染。
     - 轨迹线：遍历设备，对每个设备，查询由其发送的数据并按照时间排序，从而构建一条轨迹线（Polyline）配置信息，返回所有轨迹线信息传给前端在地图上渲染。
   - 筛选功能同上两个模块。
   - 在前端，对标记点实现点击处理函数，用户点击标记点后，相应的信息窗口呈显示状态，用户点击关闭后点击其他标记点后，原信息窗口呈关闭状态。信息窗口的信息由后端提供，和Marker配置信息一同返回。

   

6. **首页提供统计信息（设备总量、在线总量、接收的数据量等），以图表方式展示（柱状体、折线图）等**（已实现）

   提供”系统首页“界面，在该界面：

   - 显示系统统计信息：
     - 总设备数
     - 总数据量
     - 注册患者总数
     - 病房数量
   - 显示可视化图表：
     - 一周内活跃设备数量变化情况（折线图，柱状图）
     - 一周内总数据量变化情况（折线图，柱状图）
     - 一周内注册患者数变化情况（折线图，柱状图）
     - 一周内活跃病房数变化情况（折线图，柱状图）
     - 现有数据”正常“”警告“比例及数量（饼图）
     - 现有设备”在线“”离线“”故障“比例及数量（饼图）

   **实现方法：**

   考虑到设备和数据信息的数据量可能会有一定规模，如果交由前端处理可能会受限于浏览器的性能。为了实现这一功能，后端提供了相关的接口，由后端直接对数据库数据进行统计，再将结果传递到前端，前端只需要调用所需的可视化组件显示即可。

增强功能：

7. **样式适配手机端，能够在手机浏览器/微信等应用内置的浏览器中友好显示**（已实现）

   **实现方法：**
   
   - 前端界面的css格式，不采用绝对布局（使用`px`作为单位固定组件长宽），而是使用屏幕长宽的百分比设定组件大小。
   - 采用 `@media `等自适应布局，根据设备信息设置组件的长宽。



### 2.2 扩展功能

为了让“智慧病房平台”功能更全面、更有应用价值，本项目还计划增加以下的拓展功能。

1. **设定不同的用户：管理人员/医生/患者，并分配不同的用户权限**（部分实现）

   - 管理人员：
     - 可以查看所有数据
     - 可以修改设备信息、删除设备
     - 可以删除数据
   - 医生：
     - 可以查看所有信息
     - 不能进行信息的修改和删除
   - 患者：
     - 只能查看自己所在病房的环境数据，如：室内温湿度（未实现）
     - 只能查看自己的个人数据，如：体温、心率（未实现）
     - 不能进行信息的修改和删除

   **实现方法：**

   主要由前端实现。

   - 首先，需要通过localStorage保存当前登录用户的身份信息。
   - 在前端路由设置中，设定低权限用户无法访问某些界面。当检测到低权限用户发出跳转到高权限页面的请求时，将页面重定向到403页面。
   - 在前端页面设计时，利用`v-if`属性，对于低权限用户，不显示相关操作的入口。

   具体实现时，完全实现了管理人员和医生的权限，对于患者的权限，只是实现了高权限界面不可见，没有实现对个人数据的访问。

   

2. **增加数据导出功能**（已实现）

   用户可以将选定时间范围内、选定设备的数据信息导出为excel等文件格式。

   **实现方法：**

   在基础功能部分已经介绍过。

   

3. **对比分析功能（未实现）

   用户可以不局限于分析单个传感器设备的历史数据（功能4）、或是所有设备某一时刻的数据（功能5），用户可以选择多个传感器，对比分析它们的历史数据。如：选择一个病人的“体温”和“心率”两种数据，综合分析病况；选择多个病人的“体温”数据，对比分析。

   

4. **多样的可视分析功能（基本实现）

   对于这一一个数据量大的平台，我们可以使用多种可视化工具辅助数据分析。可以使用的图表形式有：散点图、玫瑰图、热力图等等。目前有许多成熟的前端可视化组件可以利用。

   **实现方法：**

   主要通过调用echarts组件，设定不同的配置参数实现。目前实现了：

   - 基本图表的显示
   - 同一份数据，用户可在不同类型图表中切换
   - 图表可保存为图片到本地

   

5. **系统主页显示实时时钟，并每秒 / 每分更新页面显示数据**（已实现）

   为了更好地契合应用场景，在系统主页增加了时钟显示，每分钟刷新时钟，同时获取最新的统计信息、最新接收的数据信息并显示在表格中。

   **实现方法：**

   主要由前端实现。在前端界面开始渲染前，定义一个timer，设定其每分钟执行指定任务（也可设定为每秒钟），包括——刷新时钟的时间、重新获取首页统计数据、重新获取按照时间排序的数据信息。

   

6. **主页统计信息模块，增加友好的用户交互功能**（已实现）

   主页以卡片的形式显示系统的基本统计数据，同时，若用户点击卡片，则主页的图表显示该卡片对应数据类别的统计图表。如：用户点击”总数据量“卡片，则图表显示为”一周内总数据量变化情况“折线图。

   **实现方法：**

   在前端界面维护一个变量指定当前需要显示的图表。并实现卡片点击的响应函数，检测到点击事件发生后，更改相关变量的值。同时，图表需要与该变量绑定，以实现图表的即时变化。





## 3 系统流程图

<img src="./assets/flow.png">



## 4 技术框架

### 4.1 项目框架图

<img src="./assets/frame.png">

项目整体上采取的是Browser/Server架构，并采用了前后端分离的开发模式。

后端负责提供接口，操作数据库提供给前端所需的数据和状态；前端负责调用接口，将数据展示给用户，并对用户的操作进行简单处理转发给后端，同时还要负责接收来自传感器的数据；数据库负责存储数据。在实际应用场景中，用户可以通过浏览器在不同的网页界面之间浏览，根据网页所需要的数据和用户的操作，浏览器会发出HTTP请求向后端服务器请求数据。后端的MQTT服务器同时在接受来自传感器发送的数据，并存储到数据库中。

### 4.2 前端技术与实现

本项目暂定使用Vue.js作为前端框架。Vue是一套用于构建用户界面的渐进式 JavaScript框架。Vue 的核心库只关注视图层，并且非常容易学习，也非常容易与其他库或已有项目整合。此外，Vue还具有轻量级、组件化、客户端路由等特点，这使得它具有易理解、代码量小的优势，这也是本项目使用 Vue框架的主要原因。希望能够将更多的精力放在整个B/S体系的软件设计与功能实现的层面。

至于UI组件库，我选择了对Vue有较好支持的Element组件库，并参考了前端框架vue-element-admin的逻辑进行设计，该框架是一个基于Vue和ElementUI的后台前端解决方案，拥有设计良好的用户交互界面。

目前项目刚刚开始，代码结构尚不完善。下面简单展示/front-end/src/目录下的各个文件夹结构，并稍作解释。

```
D:.
├─App.vue
├─api
│  ├─usr.js
│  └─***
│   // 该文件下是后端提供的API
├─assets
│  ├─logo.png
│  └─***
│   // 该文件夹下存放了页面所需的图片、字体等文件
├─components
│  ├─HomePage
│  └─***
│   // Vue的各个组件
├─router
│  └─index.js
│   // 页面路由，处理各个页面之间的跳转逻辑
├─store
│  └─modules
└─views
   ├─home
   ├─login
   └─***
    // 具体的各个视图
```

在后期具体实现时，将会不断完善上面的结构。



### 4.3 后端技术与实现

本项目暂定使用Node.js进行后端开发，达成前后端编程环境统一。Node.js是一个基于Chrome V8的JavaScript运行环境，它的特点在于事件驱动和非阻塞I/O，适合做高并发的服务器服务。

至于MQTT服务器的实现，可以使用Java、Javascript、C/C++、Python等多种语言，该项目暂定同样使用node.js使用JavaScript语言来搭建MQTT服务器，也是出于编程语言一致的考虑。但具体实现时，可能会根据实际情况做出调整。

项目的数据库采用的是MySQL数据库，MySQL是一种关系型数据库，采用传统的sql语句进行查询。由于先修的数据库课程，我对MySQL更为熟悉。同时，考虑到MySQL相较于MongoDB更为成熟稳定，且该项目中的数据格式已经非常明确了，所以最后选择采用MySQL数据库。




## 5 数据库设计

### 5.1 ER模型

<img src="./assets/er.png">

### 5.2 表头设计

#### 5.2.1 设备Facility

| 列名  | 说明 |    类型     | 约束 |
| :---: | :---------: | :------: | :---------------------------------: |
| facID | 设备ID | varchar(20) |             Primary Key             |
| name | 设备名 | varchar(30) |                                     |
| type  | 设备类型：温度、湿度、体温、心率 | varchar(10) | in (“temp”, “humi”, “bodyt”, “rate”) |
| state |  设备状态  | varchar(10) |  in (“online”, “offline”, “error”)  |
| unit  | 设备数据单位 | varchar(10) |                                     |
| step | 时间步长（单位：分钟） | INT |                                     |

#### 5.2.2 用户User

|  列名  |   说明   |    类型     |                 约束                 |
| :----: | :------: | :---------: | :----------------------------------: |
| userID |  用户ID  | varchar(20) |             Primary Key              |
| email  | 注册邮箱 | varchar(50) |          Not Empty & Unique          |
|  name  |  用户名  | varchar(30) |          Not Empty & Unique          |
| passwd | 用户密码 | varchar(40) |              Not Empty               |
|  type  | 用户种类 | varchar(10) | in (“doctor”, “patient”, “manager” ) |

#### 5.2.3 用户设备对应关系Own

该关系表示userID用户（患者）对应facID（体温、心率）

|  列名  |    说明    |    类型     | 约束 |
| :----: | :--------: | :---------: | :--: |
| userID | 对应用户ID | varchar(20) |      |
| facID  | 对应设备ID | varchar(20) |      |

#### 5.2.4 数据Data

|  列名  |    说明    |    类型     | 约束 |
| :----: | :--------: | :---------: | :--: |
| _ID | 该记录ID编号 | INT | Primary Key |
| facID | 对应设备ID | varchar(20) |      |
| time | 数据接收的时间 | datetime |      |
| location | 设备发送消息时所处的经纬度 | varchar(50) | |
| **wradID** | **病房ID** | **INT** | |
| type | 数据类型 | varchar(15) | in (“normal”, “warning”) |
| amount | 具体数据值 | demical(3, 2) | |



## 6 前后端API设计

以下是后端提供给前端的数据库相关API，具体实现的时候将根据情况修改，前端测试时可以使用POSTMAN工具进行调试。

### 6.1 用户登录相关

|     接口名     | 类型 |              说明              |
| :------------: | :--: | :----------------------------: |
|  create_user   | POST |           创建新用户           |
| get_user_info  | GET  | 从User表中获取该用户的个人信息 |
| edit_user_info | POST |        用户修改个人信息        |
|    del_user    | DEL  |       从User表中删除用户       |
|   user_login   | POST |            登录验证            |

### 6.2 设备管理相关

|      接口名       | 类型 |                       说明                        |
| :---------------: | :--: | :-----------------------------------------------: |
| get_patient_facID | GET  |    从own表中获取该患者对应设备号（体温、心率）    |
|    get_fac_num    | GET  | 获得现有设备的数量（可通过参数设定对state的筛选） |
|   get_fac_info    | GET  |     从Facility表中根据ID获取该设备的所有信息      |
|   edit_fac_info   | GET  |             （管理员）修改设备的信息              |

### 6.3 数据查询相关

|    接口名    | 类型 |                     说明                     |
| :----------: | :--: | :------------------------------------------: |
| get_fac_data | GET  |    在Data表中根据设备的ID查询所有相关记录    |
| get_fac_loca | GET  | 在Data表中根据设备的ID和时间范围查询地理位置 |



## 7 UI设计

为方便进一步的前端开发，在设计阶段，我们以UI原型的方式对前端界面进行初步设计。后续在实际开发中，再进行具体的功能细化和风格美化。接下来将简单介绍主页、设备管理界面、数据查询界面、地图界面四个主要界面的交互逻辑。

### 7.1 主页

页面的左方一列是导航栏，用户可通过点击跳转到其他页面。

主页将会显示系统的一些基本统计数据，如：总设备数、总数据记录数、患者数量、病房数量等。并且会通过一些图表的形式将这些统计数据可视化，设计原型中展示了平均温度的折线图、数据种类的饼图等。主页的最底部将会以表格的形式动态显示当前时刻最新接收到的数据信息。主页的数据将不断更新，显示实时数据，当前页面对应的时间可以在首最顶部看到，页面中显示的是12:00:00。

#### 用到的接口

- get_fac_num：设备总数 / 不同state的设备比例饼图
- *get_data_num*：总数据量
- *get_patient_num*：总患者数
- *get_ward_num*：总病房数
- *get_new5_data*：获取最新的五条数据记录
- 平均温度->折线图

<img src="./assets/ui-主页.png">



### 7.2 设备管理界面

设备管理的主体部分是一张表格，其中列出了系统中接入的所有设备信息。用户也可以通过上部的筛选条件对设备进行筛选，如：设备状态、设备种类、所处位置等。通过表格每条记录右端的按钮，用户可以对设备进行修改和删除。同时，点击单个设备或勾选多个设备后点击按钮，用户将跳转到数据查询界面，查看这些设备接收到的数据信息。

通过”新增“按钮，用户可以接入新的设备；通过”导出“按钮，用户可以直接将设备信息导出为Excel或其他文件形式。

#### 用到的接口

- get_patient_facID：显示当前用户可看的设备数
- （前端筛选）
- 根据变量“userType”确定是否显示“设备删除”按钮

<img src="./assets/ui-设备管理.png">



### 7.3 数据查询界面

在数据查询界面，用户可以选择特定的设备查看它们发送来的数据，选择的设备数可以是一个也可以是多个。同时，用户可以对感兴趣的时间段进行筛选，原型设计中给出了点选”今天、7天、14天、30天“和通过日历勾选两种方式。

对具体的设备数据，有两个展示区块：第一个是单个设备的数据显示，图中显示了饼图和详细的数据表格，用户可以在不同的设备间切换，该部分将用于展示单个设备的数据分布情况；第二个是不同设备数据之间的对比图表，如图中将在一张折线图中同时展示多个设备的数据信息，用户可以通过Tab按钮查看不同的可视化图表，也可以在右上方的”已选设备“中选择新的设备、删除现有已选设备。

#### 用到的接口

- get_all_faci_id：获取所有设备id，用于筛选框
- get_fac_data：根据设备id获取所有数据（如图中需要获取0001、0002、0003、0004）

<img src="./assets/ui-数据.png">



### 7.4 地图界面

该界面的主体是一张地图，实际部署时可以更换为医院地图。

地图上分布着红色和蓝色两种圆点，其中蓝色表示一次正常数据的接收，红色则表示警报数据。通过上方的”时间“区块，用户可以选择感兴趣的时间区间，查看该区间内的数据分布。在地图的下方是一张详细数据表格，其中展示了地图中显示的所有数据记录的信息，同时也标注了”正常“和”警报“，用户可以右端的”查看“按钮查看数据的详细信息。

此外，项目还计划加入一些友好的交互功能，如鼠标悬停地图中的圆点则浮现对应数据的信息框、表内记录高亮等。

<img src="./assets/ui-地图.png">





# 二、使用手册





# 三、测试报告





# 四、开发体会与小结